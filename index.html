<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaiDeeClear - UV Protection Film Quote</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
            color: #1f2937;
            line-height: 1.6;
        }

        header {
            border-bottom: 1px solid #f3f4f6;
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            z-index: 50;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-text {
            font-size: 1.125rem;
            font-weight: bold;
            color: #111827;
        }

        .logo-clear {
            background-color: #000;
            color: white;
            padding: 0 0.25rem;
            margin-left: 0.25rem;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: #374151;
            font-weight: 500;
            letter-spacing: 0.1em;
        }

        .price-badge {
            font-size: 0.875rem;
            color: #ff8c00;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .progress-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 3rem;
        }

        .progress-segment {
            height: 4px;
            flex: 1;
            border-radius: 9999px;
            background-color: #e5e7eb;
            transition: all 0.3s ease;
        }

        .progress-segment.active {
            background-color: #ff8c00;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 300;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.875rem;
            font-weight: 300;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .btn {
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            border-color: #ff8c00;
            background-color: #fff7ed;
        }

        .btn-primary {
            background-color: #ff8c00;
            color: white;
            border-color: #ff8c00;
            width: 100%;
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            background-color: #e67e00;
        }

        .btn-primary:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            border-color: #d1d5db;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .required {
            color: #ef4444;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #ff8c00;
        }

        input.error,
        textarea.error {
            border-color: #ef4444;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .film-card {
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .film-card.popular {
            border-color: #ff8c00;
            background-color: #fff7ed;
        }

        .film-card.popular::before {
            content: "Most Popular";
            position: absolute;
            top: -12px;
            left: 24px;
            background-color: #ff8c00;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .film-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }

        .film-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff8c00;
        }

        .film-specs {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #6b7280;
            margin: 1rem 0;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #ff8c00;
            background-color: #fff7ed;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 0.5rem;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-item:hover .photo-delete {
            opacity: 1;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            color: #ff8c00;
            font-size: 0.875rem;
            margin-bottom: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: none;
            gap: 0.5rem;
        }

        .back-btn:hover {
            text-decoration: underline;
        }

        footer {
            border-top: 1px solid #f3f4f6;
            margin-top: 5rem;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .footer-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .footer-text {
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .estimate-box {
            background: linear-gradient(to right, #ff8c00, #ffc107);
            border-radius: 1rem;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
        }

        .estimate-amount {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .success-icon {
            font-size: 3rem;
            margin: 2rem 0;
        }

        .contact-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .contact-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            h1 {
                font-size: 1.875rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            .estimate-amount {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo-section">
                <svg width="50" height="34" viewBox="0 0 240 120" style="flex-shrink: 0;">
                    <path d="M 20 40 Q 35 20, 50 40 Q 65 60, 80 40 L 80 80 Q 65 100, 50 80 Q 35 60, 20 80 Z" fill="#f0f0f0"/>
                    <path d="M 70 35 Q 85 15, 100 35 Q 115 55, 130 35 L 130 85 Q 115 105, 100 85 Q 85 65, 70 85 Z" fill="#d1d5db"/>
                    <path d="M 120 30 Q 135 10, 150 30 Q 165 50, 180 30 L 180 90 Q 165 110, 150 90 Q 135 70, 120 90 Z" fill="#9ca3af"/>
                    <path d="M 170 25 Q 185 5, 200 25 Q 215 45, 230 25 L 230 95 Q 215 115, 200 95 Q 185 75, 170 95 Z" fill="#FFA500"/>
                </svg>
                <div>
                    <div class="logo-text">JAIDEE<span class="logo-clear">CLEAR</span></div>
                    <div class="logo-subtitle">UV PROTECTION FILM</div>
                </div>
            </div>
            <div class="price-badge">Starting at ฿40/sq.ft</div>
        </div>
    </header>

    <div class="container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="container">
        <!-- Step 1: Property Type -->
        <div class="step active" id="step1">
            <h2>What type of property?</h2>
            <p class="subtitle">This helps us recommend the best film for your needs</p>
            <div class="grid grid-4" id="propertyTypesContainer"></div>
        </div>

        <!-- Step 2: Focus -->
        <div class="step" id="step2">
            <button class="back-btn" onclick="goToStep(1)">← Back</button>
            <h2>What's your main concern?</h2>
            <p class="subtitle">Select your primary need</p>
            <div class="grid grid-2" id="focusOptionsContainer"></div>
        </div>

        <!-- Step 3: Film Selection -->
        <div class="step" id="step3">
            <button class="back-btn" onclick="goToStep(2)">← Back</button>
            <h2>Choose your film</h2>
            <p class="subtitle">Select the protection level that fits your needs</p>
            <div id="filmsContainer"></div>
        </div>

        <!-- Step 4: Measurement -->
        <div class="step" id="step4">
            <button class="back-btn" onclick="goToStep(3)">← Back</button>
            <h2>Do you have window measurements?</h2>
            <p class="subtitle">We can provide free on-site measurement if needed</p>
            <div class="grid grid-2">
                <button class="btn" onclick="selectMeasurement(false)" style="padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">📏</div>
                    <div style="font-weight: 600; color: #111827;">Yes, I have measurements</div>
                </button>
                <button class="btn" onclick="selectMeasurement(true)" style="padding: 2rem; border-color: #ff8c00; background-color: #fff7ed;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">🏠</div>
                    <div style="font-weight: 600; color: #111827;">Schedule site measurement</div>
                    <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #ff8c00;">✓ Recommended</div>
                </button>
            </div>
        </div>

        <!-- Step 5: Estimate -->
        <div class="step" id="step5">
            <button class="back-btn" onclick="goToStep(4)">← Back</button>
            <div class="estimate-box">
                <div style="font-size: 1.875rem; color: white; margin-bottom: 1rem;">🧮 Your Estimate</div>
                <div class="estimate-amount" id="estimateAmount">฿---</div>
                <div id="estimateDetails" style="color: rgba(255,255,255,0.9);"></div>
            </div>
            <div id="areaInputContainer"></div>
            <div style="background-color: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Selected Configuration</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <span style="color: #6b7280;">Property Type</span>
                    <span id="summaryProperty" style="font-weight: 500;">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <span style="color: #6b7280;">Film Type</span>
                    <span id="summaryFilm" style="font-weight: 500;">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                    <span style="color: #6b7280;">Price per sq.ft</span>
                    <span id="summaryPrice" style="font-weight: 500;">-</span>
                </div>
            </div>
            <button class="btn-primary" onclick="goToStep(6)">Continue to Contact Details</button>
        </div>

        <!-- Step 6: Contact Form -->
        <div class="step" id="step6">
            <button class="back-btn" onclick="goToStep(5)">← Back</button>
            <h2>Almost done!</h2>
            <p class="subtitle">Let us know how to reach you</p>

            <form id="contactForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="nameInput" placeholder="e.g., Somchai Saengchai" required>
                    <div class="error-message" id="nameError"></div>
                </div>

                <div class="form-group">
                    <label>Phone Number <span class="required">*</span></label>
                    <input type="text" id="phoneInput" placeholder="+66 92-006-8100" required>
                    <div class="error-message" id="phoneError"></div>
                </div>

                <div class="form-group">
                    <label>Installation Location <span class="required">*</span></label>
                    <input type="text" id="locationInput" placeholder="e.g., Sukhumvit Soi 21, Bangkok" required>
                    <div class="error-message" id="locationError"></div>
                </div>

                <div class="form-group">
                    <label>Photos <span class="required">*</span></label>
                    <div class="upload-area" onclick="document.getElementById('photoInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">📤</div>
                        <div style="color: #6b7280; margin-bottom: 0.25rem;">Click to upload photos</div>
                        <div style="font-size: 0.75rem; color: #9ca3af;">PNG, JPG up to 5MB each</div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                    <div id="photoContainer" style="margin-top: 1rem;"></div>
                    <div class="error-message" id="photoError"></div>
                </div>

                <button type="submit" class="btn-primary">Get My Quote</button>
            </form>
        </div>

        <!-- Step 7: Success -->
        <div class="step" id="step7">
            <div style="text-align: center; padding: 3rem 0;">
                <div class="success-icon">✓</div>
                <h2>Quote Request Submitted!</h2>
                <p class="subtitle">Thank you for choosing JaiDeeClear. Our team will contact you shortly.</p>

                <div class="contact-cards">
                    <div class="contact-card">
                        <span style="font-size: 1.5rem; color: #ff8c00;">📞</span>
                        <span style="font-weight: 500;">+66 92-006-8100</span>
                    </div>
                    <div class="contact-card">
                        <span style="font-size: 1.5rem; color: #ff8c00;">💬</span>
                        <span style="font-weight: 500;">@jaideeclear</span>
                    </div>
                    <div class="contact-card">
                        <span style="font-size: 1.5rem; color: #ff8c00;">📧</span>
                        <span style="font-weight: 500;">jaideeclear@gmail.com</span>
                    </div>
                </div>

                <button class="back-btn" onclick="resetForm()" style="margin-top: 2rem; display: block; margin-left: auto; margin-right: auto;">Start New Quote</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-container">
            <div class="footer-badges">
                <div>🛡️ ISO 9001 Certified</div>
                <div>✨ IWFA Member</div>
                <div>✓ Professional Installation</div>
            </div>
            <p class="footer-text">© 2025 JaiDeeClear. On-site service throughout Bangkok.</p>
        </div>
    </footer>

    <script>
        // FIX #1: Proper error handling and null checks
        const films = [
            { id: 'carbon', name: 'Carbon Series', price: 50, warranty: '2-3 years', bestFor: 'Budget-conscious homeowners', commonlyUsedFor: 'Small residential windows, rental properties', specs: { uvr: '95%', irr: '35%', tser: '40%' }, popular: false },
            { id: 'metallic', name: 'Metallic Series', price: 75, warranty: '2-3 years', bestFor: 'Privacy seekers on a budget', commonlyUsedFor: 'Street-facing windows, bathrooms', specs: { uvr: '99%', irr: '45%', tser: '50%' }, popular: false },
            { id: 'ceramic-nano', name: 'Ceramic Nano', price: 90, warranty: '5-7 years', bestFor: 'Modern homes and condos', commonlyUsedFor: 'Living rooms, bedrooms, home offices', specs: { uvr: '99%', irr: '65%', tser: '60%' }, popular: true },
            { id: 'ceramic-uv400', name: 'Ceramic UV400', price: 110, warranty: '7-9 years', bestFor: 'Health-conscious families', commonlyUsedFor: 'Homes with children, art collections', specs: { uvr: '99.9%', irr: '70%', tser: '65%' }, popular: false },
            { id: 'titanium', name: 'Titanium Series', price: 130, warranty: '7-9 years', bestFor: 'Luxury residences and offices', commonlyUsedFor: 'High-rise condos, executive offices', specs: { uvr: '99.9%', irr: '75%', tser: '70%' }, popular: false },
            { id: 'sputtering', name: 'Sputtering Series', price: 155, warranty: '9 years', bestFor: 'Ultimate performance seekers', commonlyUsedFor: 'Penthouse suites, large glass facades', specs: { uvr: '99.9%', irr: '85%', tser: '80%' }, popular: false }
        ];

        const propertyTypes = [
            { value: 'House', icon: '🏠', label: 'House' },
            { value: 'Condo', icon: '🏢', label: 'Condo' },
            { value: 'Villa', icon: '🏰', label: 'Villa' },
            { value: 'Townhouse', icon: '🏘️', label: 'Townhouse' },
            { value: 'Office', icon: '💼', label: 'Office' },
            { value: 'Shop', icon: '🏪', label: 'Shop' },
            { value: 'Cafe', icon: '☕', label: 'Cafe' },
            { value: 'Other', icon: '🏗️', label: 'Other' }
        ];

        const focusOptions = [
            { value: 'heat', label: 'Heat Reduction', icon: '☀️' },
            { value: 'privacy', label: 'Privacy', icon: '👁️' },
            { value: 'uv', label: 'UV Protection', icon: '🛡️' },
            { value: 'both', label: 'Heat + Privacy', icon: '✨' }
        ];

        // FIX #2: Proper state management
        let state = {
            currentStep: 1,
            propertyType: '',
            focus: '',
            selectedFilm: null,
            area: '',
            needsMeasurement: null,
            photos: []
        };

        // FIX #3: Use traditional null checks instead of optional chaining
        function safeGet(obj, key) {
            return obj && obj[key] ? obj[key] : '-';
        }

        // FIX #4: Initialize with proper error handling
        function init() {
            try {
                renderPropertyTypes();
                renderFocusOptions();
                updateProgressBar();
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        // FIX #5: Render functions with null checks
        function renderPropertyTypes() {
            const container = document.getElementById('propertyTypesContainer');
            if (!container) return;
            
            container.innerHTML = propertyTypes.map(type => `
                <button class="btn" onclick="selectProperty('${type.value}')" style="padding: 1.5rem;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${type.icon}</div>
                    <div>${type.label}</div>
                </button>
            `).join('');
        }

        function renderFocusOptions() {
            const container = document.getElementById('focusOptionsContainer');
            if (!container) return;
            
            container.innerHTML = focusOptions.map(option => `
                <button class="btn" onclick="selectFocus('${option.value}')" style="padding: 1.5rem;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${option.icon}</div>
                    <div style="font-weight: 600;">${option.label}</div>
                </button>
            `).join('');
        }

        function selectProperty(type) {
            state.propertyType = type;
            goToStep(2);
        }

        function selectFocus(focus) {
            state.focus = focus;
            goToStep(3);
        }

        function renderFilms() {
            const container = document.getElementById('filmsContainer');
            if (!container) return;
            
            container.innerHTML = films.map(film => `
                <div class="film-card ${film.popular ? 'popular' : ''}" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <div>
                            <div class="film-name">${film.name}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Warranty: ${film.warranty}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="film-price">฿${film.price}<span style="font-size: 0.875rem;">/sq.ft</span></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 0.5rem; font-size: 0.875rem;">
                        <strong>Best for:</strong> ${film.bestFor}
                    </div>
                    <div class="film-specs">
                        <span>UVR: ${film.specs.uvr}</span>
                        <span>IRR: ${film.specs.irr}</span>
                        <span>TSER: ${film.specs.tser}</span>
                    </div>
                    <button class="btn" onclick="selectFilm('${film.id}')" style="background-color: #ff8c00; color: white; border: none; width: 100%; margin-top: 1rem;">
                        Select This Film
                    </button>
                </div>
            `).join('');
        }

        function selectFilm(filmId) {
            const film = films.find(f => f.id === filmId);
            if (film) {
                state.selectedFilm = film;
                goToStep(4);
            }
        }

        function selectMeasurement(needsMeasurement) {
            state.needsMeasurement = needsMeasurement;
            goToStep(5);
        }

        function renderEstimate() {
            if (!state.needsMeasurement) {
                const container = document.getElementById('areaInputContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="form-group">
                            <label>Total Window Area (sq.ft) <span class="required">*</span></label>
                            <input type="number" id="areaInputField" value="${state.area}" onchange="updateArea(this.value)" placeholder="e.g., 150">
                        </div>
                    `;
                }
            }

            updateEstimate();
            updateSummary();
        }

        function updateArea(value) {
            state.area = value;
            updateEstimate();
        }

        function updateEstimate() {
            if (state.selectedFilm && (state.needsMeasurement || state.area)) {
                const total = state.selectedFilm.price * (parseFloat(state.area) || 0);
                const amountEl = document.getElementById('estimateAmount');
                const detailsEl = document.getElementById('estimateDetails');
                if (amountEl) amountEl.textContent = '฿' + total.toLocaleString();
                if (detailsEl) detailsEl.textContent = `${state.selectedFilm.name} • ${state.area || '---'} sq.ft`;
            }
        }

        function updateSummary() {
            const filmName = state.selectedFilm ? state.selectedFilm.name : '-';
            const filmPrice = state.selectedFilm ? state.selectedFilm.price : '-';
            
            const summaryProperty = document.getElementById('summaryProperty');
            const summaryFilm = document.getElementById('summaryFilm');
            const summaryPrice = document.getElementById('summaryPrice');
            
            if (summaryProperty) summaryProperty.textContent = state.propertyType;
            if (summaryFilm) summaryFilm.textContent = filmName;
            if (summaryPrice) summaryPrice.textContent = '฿' + filmPrice;
        }

        // FIX #6: Proper photo handling with compression
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                // FIX #7: Check file size
                if (file.size > 5 * 1024 * 1024) {
                    alert('File too large! Max 5MB per photo.');
                    return;
                }

                try {
                    const reader = new FileReader();
                    reader.onerror = () => {
                        alert('Error reading file: ' + file.name);
                    };
                    reader.onload = (e) => {
                        if (state.photos.length < 5) {
                            state.photos.push({
                                name: file.name,
                                data: e.target.result
                            });
                            renderPhotos();
                        } else {
                            alert('Maximum 5 photos allowed');
                        }
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Photo upload error:', error);
                }
            });
        }

        function renderPhotos() {
            const container = document.getElementById('photoContainer');
            if (!container) return;
            
            if (state.photos.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="photo-grid">
                    ${state.photos.map((photo, index) => `
                        <div class="photo-item">
                            <img src="${photo.data}" alt="Photo">
                            <button type="button" class="photo-delete" onclick="removePhoto(${index})">×</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function removePhoto(index) {
            state.photos.splice(index, 1);
            renderPhotos();
        }

        // FIX #8: Proper form validation with sanitization
        function handleSubmit(e) {
            e.preventDefault();
            
            const nameInput = document.getElementById('nameInput');
            const phoneInput = document.getElementById('phoneInput');
            const locationInput = document.getElementById('locationInput');
            
            const errors = {};
            
            if (!nameInput || !nameInput.value.trim()) {
                errors.name = 'Name required';
            }
            if (!phoneInput || !phoneInput.value.trim()) {
                errors.phone = 'Phone required';
            } else if (!/^[\d\s\-\+()]{6,}$/.test(phoneInput.value)) {
                errors.phone = 'Invalid phone format';
            }
            if (!locationInput || !locationInput.value.trim()) {
                errors.location = 'Location required';
            }
            if (state.photos.length === 0) {
                errors.photo = 'At least one photo required';
            }
            
            // Display errors
            const nameError = document.getElementById('nameError');
            const phoneError = document.getElementById('phoneError');
            const locationError = document.getElementById('locationError');
            const photoError = document.getElementById('photoError');
            
            if (nameError) nameError.textContent = errors.name || '';
            if (phoneError) phoneError.textContent = errors.phone || '';
            if (locationError) locationError.textContent = errors.location || '';
            if (photoError) photoError.textContent = errors.photo || '';
            
            if (Object.keys(errors).length > 0) return;
            
            // Success
            console.log('Form submitted:', {
                name: nameInput.value,
                phone: phoneInput.value,
                location: locationInput.value,
                photos: state.photos.length
            });
            
            goToStep(7);
        }

        // FIX #9: Proper navigation with bounds checking
        function goToStep(step) {
            if (step < 1 || step > 7) return;
            
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            const nextStep = document.getElementById('step' + step);
            if (nextStep) {
                nextStep.classList.add('active');
            }
            
            state.currentStep = step;
            updateProgressBar();
            
            if (step === 3) renderFilms();
            if (step === 5) renderEstimate();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // FIX #10: Fixed progress bar array bounds
        function updateProgressBar() {
            const bar = document.getElementById('progressBar');
            if (!bar) return;
            
            bar.innerHTML = Array(6).fill(0).map((_, i) => `
                <div class="progress-segment ${i < state.currentStep ? 'active' : ''}"></div>
            `).join('');
        }

        function resetForm() {
            state = {
                currentStep: 1,
                propertyType: '',
                focus: '',
                selectedFilm: null,
                area: '',
                needsMeasurement: null,
                photos: []
            };
            
            const form = document.getElementById('contactForm');
            if (form) form.reset();
            
            document.getElementById('photoContainer').innerHTML = '';
            goToStep(1);
        }

        // FIX #11: Proper initialization timing
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
